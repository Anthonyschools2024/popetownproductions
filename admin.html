<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POPETOWN Admin | Command Center v4.1</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --brand-red: #ff0000;
            --bg-black: #050505;
            --panel-bg: rgba(10, 10, 10, 0.95);
        }
        body {
            background-color: var(--bg-black);
            color: #ffffff;
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
            scroll-behavior: smooth;
        }
        h1, h2, h3 { font-family: 'Orbitron', sans-serif; }
        
        #adminNav {
            position: fixed !important;
            top: 0 !important; left: 0 !important;
            width: 100% !important; height: 80px !important;
            z-index: 9999; 
            background: rgba(0, 0, 0, 0.98) !important;
            backdrop-filter: blur(25px);
            border-bottom: 1px solid rgba(255, 0, 0, 0.3);
            display: none; 
            align-items: center;
            padding: 0 2rem;
        }

        .glass-panel {
            background: var(--panel-bg);
            border: 1px solid rgba(255, 0, 0, 0.15);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.8);
            border-radius: 4px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .glass-panel:hover { border-color: rgba(255, 0, 0, 0.5); }

        .neon-accent {
            color: var(--brand-red);
            text-shadow: 0 0 15px rgba(255, 0, 0, 0.8);
        }

        .btn-red {
            background: var(--brand-red);
            color: white;
            padding: 14px 28px;
            text-transform: uppercase;
            font-weight: 700;
            letter-spacing: 3px;
            transition: 0.4s;
            cursor: pointer;
            border: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 11px;
        }

        .btn-red:hover:not(:disabled) {
            box-shadow: 0 0 30px rgba(255, 0, 0, 0.7);
            filter: brightness(1.2);
        }
        
        .btn-red:disabled { opacity: 0.3; cursor: wait; }

        .nav-link {
            color: #666;
            font-size: 10px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 2px;
            transition: 0.3s;
            padding: 10px 15px;
        }
        .nav-link:hover { color: white; background: rgba(255, 0, 0, 0.1); }

        .file-upload-wrapper {
            border: 2px dashed rgba(255, 0, 0, 0.1);
            height: 220px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.01);
            position: relative;
            overflow: hidden;
            transition: 0.3s;
        }

        .asset-actions {
            position: absolute;
            top: 15px; right: 15px;
            display: flex; gap: 10px;
            z-index: 50;
        }

        .asset-btn {
            background: rgba(0,0,0,0.9);
            border: 1px solid rgba(255,255,255,0.1);
            color: white; padding: 8px;
            border-radius: 4px; cursor: pointer;
            transition: 0.2s;
        }
        .asset-btn:hover { background: #ff0000; border-color: #ff0000; }

        .progress-container {
            width: 100%; height: 6px;
            background: rgba(0,0,0,0.4);
            position: absolute; bottom: 0; left: 0;
        }
        .progress-bar {
            height: 100%; background: var(--brand-red);
            width: 0%; transition: width 0.2s;
            box-shadow: 0 0 15px var(--brand-red);
        }

        #canvas-container {
            position: fixed; top: 0; left: 0; z-index: -1;
            width: 100%; height: 100%; pointer-events: none;
        }

        input, textarea, select {
            background: rgba(15, 15, 15, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.05);
            color: white; padding: 1rem;
            outline: none; width: 100%;
            font-size: 13px;
        }
        input:focus { border-color: var(--brand-red); background: rgba(20, 20, 20, 1); }

        #accessBarrier {
            position: fixed; inset: 0;
            background: #000; z-index: 10000;
            display: flex; align-items: center; justify-content: center;
        }

        .error-toast {
            background: #000; color: #ff0000;
            padding: 1.5rem; position: fixed;
            bottom: 2rem; right: 2rem; z-index: 11000;
            font-size: 10px; font-weight: 900;
            text-transform: uppercase; display: none;
            border: 1px solid #ff0000;
            box-shadow: 0 0 40px rgba(255,0,0,0.3);
        }

        .hidden { display: none !important; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: var(--brand-red); }
    </style>
</head>
<body class="custom-scrollbar">

    <div id="canvas-container"></div>
    <div id="errorToast" class="error-toast"></div>

    <!-- SECURITY BARRIER -->
    <div id="accessBarrier">
        <div class="glass-panel p-16 max-w-lg w-full text-center border-t-[6px] border-red-600">
            <h2 class="text-4xl font-black mb-2 uppercase tracking-tighter italic text-white">POPETOWN <span class="text-red-600">ADMIN</span></h2>
            <p class="text-[10px] text-zinc-500 uppercase tracking-[0.5em] mb-12">Authorized Personnel Access Only</p>
            
            <form id="loginForm" class="space-y-6 text-left">
                <div class="space-y-2">
                    <label class="text-[9px] uppercase text-zinc-600 font-black tracking-widest ml-1">Staff ID / Email</label>
                    <input type="email" id="loginEmail" placeholder="ID_ALPHA_01" required class="font-mono text-white">
                </div>
                <div class="space-y-2">
                    <label class="text-[9px] uppercase text-zinc-600 font-black tracking-widest ml-1">Access Cipher</label>
                    <input type="password" id="loginPass" placeholder="••••••••" required class="text-white">
                </div>
                <button type="submit" id="loginBtn" class="btn-red w-full mt-6 shadow-2xl">
                    <i data-lucide="shield-check" class="w-4 h-4"></i> Establish Secure Uplink
                </button>
            </form>
            <div id="initStatus" class="mt-10 text-[9px] font-mono text-zinc-800 uppercase tracking-[0.2em] animate-pulse">Scanning Grid Pulse...</div>
        </div>
    </div>

    <!-- COMMAND CENTER -->
    <div id="adminContent" class="hidden">
        <header id="adminNav">
            <div class="max-w-screen-2xl mx-auto w-full flex justify-between items-center px-8">
                <div class="flex items-center gap-12">
                    <div class="text-2xl font-black tracking-tighter uppercase italic cursor-pointer group">
                        POPETOWN <span class="neon-accent group-hover:animate-pulse">CMD</span>
                    </div>
                    <nav class="hidden lg:flex gap-4">
                        <a href="#eventSection" class="nav-link">Production</a>
                        <a href="#gallerySection" class="nav-link">Media_Core</a>
                        <a href="#archiveSection" class="nav-link">Archive</a>
                        <a href="#signalSection" class="nav-link">Signals</a>
                    </nav>
                </div>
                <div class="flex items-center gap-8">
                    <div class="relative hidden xl:block text-left">
                        <i data-lucide="search" class="w-4 h-4 absolute left-4 top-1/2 -translate-y-1/2 text-zinc-600"></i>
                        <input type="text" id="globalSearch" placeholder="SEARCH CORE DATABASE..." class="pl-12 text-[10px] py-3 bg-white/5 border-white/5 w-80 rounded-sm font-bold uppercase tracking-widest focus:border-red-600">
                    </div>
                    <button id="logoutBtn" class="text-[9px] text-zinc-500 hover:text-white uppercase border border-white/5 px-6 py-2 hover:bg-red-600/20 hover:border-red-600 transition-all font-black tracking-tighter">
                        TERMINATE_LINK
                    </button>
                </div>
            </div>
        </header>

        <main class="pt-36 pb-32 px-8 max-w-screen-2xl mx-auto space-y-24">
            <!-- Analytics -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                <div class="md:col-span-2 text-left">
                    <h1 class="text-5xl md:text-7xl font-black uppercase tracking-tighter leading-none italic">COMMAND<br><span class="text-red-600">TERMINAL</span></h1>
                    <p id="userDisplay" class="text-[11px] text-zinc-500 mt-4 tracking-[0.4em] uppercase font-bold border-l-2 border-red-600 pl-4">System Operational // Link Stable</p>
                </div>
                <div class="glass-panel p-6 flex flex-col justify-center text-left">
                    <p class="text-[9px] text-zinc-500 uppercase font-black tracking-widest mb-1">Active Nodes</p>
                    <div class="flex items-baseline gap-2">
                        <span id="statEvents" class="text-4xl font-black text-white">00</span>
                        <span class="text-red-600 text-xs font-mono">/ LIVE</span>
                    </div>
                </div>
                <div class="glass-panel p-6 flex flex-col justify-center text-left">
                    <p class="text-[9px] text-zinc-500 uppercase font-black tracking-widest mb-1">Intercepted Signals</p>
                    <div class="flex items-baseline gap-2">
                        <span id="statSignals" class="text-4xl font-black text-white">00</span>
                        <span class="text-zinc-600 text-xs font-mono">/ TOTAL</span>
                    </div>
                </div>
            </div>

            <!-- PRODUCTION GRID -->
            <section id="eventSection" class="space-y-12">
                <div class="flex justify-between items-end border-b border-white/5 pb-8">
                    <div class="text-left">
                        <h2 class="text-2xl font-black uppercase tracking-widest text-white">Production <span class="text-red-600">Grid</span></h2>
                        <p class="text-[10px] text-zinc-600 uppercase tracking-widest mt-2 italic text-left">Deploy and manage live event nodes and ticketing links</p>
                    </div>
                    <div id="nodeStatus" class="text-[9px] font-mono bg-zinc-900 px-6 py-2 border border-white/5 text-zinc-500 uppercase tracking-widest">Network: Syncing...</div>
                </div>

                <div class="grid xl:grid-cols-3 gap-12 items-start">
                    <!-- Form -->
                    <div class="xl:col-span-1 glass-panel p-10 space-y-8 sticky top-36">
                        <h3 class="text-sm font-black uppercase tracking-[0.3em] flex items-center gap-3">
                            <span class="w-2 h-2 bg-red-600 rounded-full animate-pulse"></span> Node Uplink
                        </h3>
                        <form id="eventForm" class="space-y-6">
                            <input type="hidden" id="editEventId">
                            <input type="text" id="evTitle" placeholder="PRODUCTION TITLE" required class="text-lg font-bold text-white">
                            
                            <div class="grid grid-cols-2 gap-4">
                                <input type="date" id="evDate" required class="text-white">
                                <select id="evStatus" class="text-white">
                                    <option value="Upcoming">UPCOMING</option>
                                    <option value="Live Now">LIVE NOW</option>
                                    <option value="Sold Out">SOLD OUT</option>
                                    <option value="Exclusive">EXCLUSIVE</option>
                                </select>
                            </div>

                            <input type="url" id="evTicketLink" placeholder="ADD TICKET PORTAL LINK (OPTIONAL)" class="font-mono text-xs text-white">

                            <textarea id="evDesc" rows="4" placeholder="TECHNICAL BRIEFING DATA..." class="custom-scrollbar text-white text-left"></textarea>
                            
                            <div class="file-upload-wrapper group" id="evDropZone">
                                <div id="evImageActions" class="asset-actions hidden">
                                    <button type="button" onclick="window.clearAsset('ev')" class="asset-btn" title="Purge Asset">
                                        <i data-lucide="trash-2" class="w-4 h-4 text-white"></i>
                                    </button>
                                </div>
                                <div id="evPrompt" class="flex flex-col items-center justify-center p-6 text-center cursor-pointer" onclick="document.getElementById('evFile').click()">
                                    <p class="text-[9px] text-zinc-500 uppercase font-black leading-relaxed">
                                        Broadcast Visual Asset<br>
                                        <span class="text-red-600 opacity-60">(Binary Uplink Support: 500MB)</span>
                                    </p>
                                </div>
                                <img id="evPreview" class="hidden h-full w-full object-cover">
                                <div id="evProgressContainer" class="progress-container hidden">
                                    <div id="evProgressBar" class="progress-bar"></div>
                                </div>
                            </div>
                            
                            <input type="hidden" id="evImageData"> 

                            <div class="flex flex-col gap-4">
                                <button type="submit" id="evBtn" class="btn-red w-full py-5">
                                    <i data-lucide="zap" class="w-4 h-4"></i> Commit Broadcast
                                </button>
                                <button type="button" id="evCancelBtn" class="hidden text-[9px] text-zinc-600 hover:text-white uppercase tracking-widest border border-white/10 px-6 py-2 hover:bg-white/5">ABORT_EDIT</button>
                            </div>
                        </form>
                    </div>

                    <!-- List -->
                    <div class="xl:col-span-2 space-y-6">
                        <div id="eventList" class="grid gap-6">
                            <div class="py-20 text-center text-[10px] text-zinc-800 uppercase tracking-[1em] animate-pulse">Establishing Database Link...</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- MEDIA GALLERY (NEW) -->
            <section id="gallerySection" class="space-y-12">
                <div class="flex justify-between items-end border-b border-white/5 pb-8 text-left">
                    <div>
                        <h2 class="text-2xl font-black uppercase tracking-widest text-white">Media <span class="text-red-600">Core</span></h2>
                        <p class="text-[10px] text-zinc-600 uppercase tracking-widest mt-2 italic">Broadcast Video & Images directly to the Gallery subpage</p>
                    </div>
                </div>
                
                <div class="grid lg:grid-cols-3 gap-12">
                    <!-- Media Form -->
                    <div class="lg:col-span-1 glass-panel p-10 space-y-8">
                        <h3 class="text-sm font-black uppercase tracking-[0.3em]">Direct Media Broadcast</h3>
                        <form id="mediaGalleryForm" class="space-y-6">
                            <input type="text" id="mgTitle" placeholder="ASSET TITLE" required class="text-white">
                            
                            <div class="grid grid-cols-2 gap-4">
                                <select id="mgType" class="text-white">
                                    <option value="image">Still_Capture</option>
                                    <option value="video">Motion_Visual</option>
                                </select>
                                <input type="text" id="mgCategory" placeholder="CATEGORY (e.g. Cinema)" class="text-white text-xs">
                            </div>

                            <div class="file-upload-wrapper group" id="mgDropZone">
                                <div id="mgImageActions" class="asset-actions hidden">
                                    <button type="button" onclick="window.clearAsset('mg')" class="asset-btn">
                                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                                    </button>
                                </div>
                                <div id="mgPrompt" class="flex flex-col items-center justify-center p-8 text-center cursor-pointer" onclick="document.getElementById('mgFile').click()">
                                    <p class="text-[9px] text-zinc-500 uppercase font-black leading-relaxed">
                                        Select Image or Video<br>
                                        <span class="text-red-600 opacity-60">(Unlimited Capacity Uplink)</span>
                                    </p>
                                </div>
                                <img id="mgPreview" class="hidden h-full w-full object-cover">
                                <video id="mgVideoPreview" class="hidden h-full w-full object-cover" muted loop playsinline></video>
                                
                                <div id="mgProgressContainer" class="progress-container hidden">
                                    <div id="mgProgressBar" class="progress-bar"></div>
                                </div>
                            </div>
                            <input type="hidden" id="mgImageData">
                            
                            <button type="submit" id="mgBtn" class="btn-red w-full py-5">
                                <i data-lucide="cast" class="w-4 h-4"></i> Broadcast to Gallery
                            </button>
                        </form>
                    </div>

                    <!-- Media Grid Management -->
                    <div class="lg:col-span-2">
                        <div id="mediaGalleryList" class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                            <!-- Injected Gallery Items -->
                        </div>
                    </div>
                </div>
            </section>

            <!-- LEGACY ARCHIVE -->
            <section id="archiveSection" class="space-y-12">
                <div class="flex justify-between items-end border-b border-white/5 pb-8 text-left">
                    <div>
                        <h2 class="text-2xl font-black uppercase tracking-widest text-white">Home <span class="text-red-600">Archive</span></h2>
                        <p class="text-[10px] text-zinc-600 uppercase tracking-widest mt-2 italic">Management of assets rendered on the main index carousel</p>
                    </div>
                </div>
                
                <div class="grid lg:grid-cols-3 gap-12">
                    <div class="lg:col-span-1 glass-panel p-10 space-y-8">
                        <form id="galleryForm" class="space-y-6">
                            <input type="text" id="galTitle" placeholder="DATA RECORD LABEL" required class="text-white">
                            <input type="text" id="galLog" placeholder="LOG_INDEX (e.g. CORE_01)" class="font-mono text-white">
                            
                            <div class="file-upload-wrapper group" id="galDropZone">
                                <div id="galImageActions" class="asset-actions hidden">
                                    <button type="button" onclick="window.clearAsset('gal')" class="asset-btn">
                                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                                    </button>
                                </div>
                                <div id="galPrompt" class="flex flex-col items-center justify-center p-8 text-center cursor-pointer" onclick="document.getElementById('galFile').click()">
                                    <p class="text-[9px] text-zinc-500 uppercase font-black leading-relaxed">
                                        Upload Capture Metadata<br>
                                        <span class="text-red-600 opacity-60">(Resumable Sync Active)</span>
                                    </p>
                                </div>
                                <img id="galPreview" class="hidden h-full w-full object-cover">
                                <div id="galProgressContainer" class="progress-container hidden">
                                    <div id="galProgressBar" class="progress-bar"></div>
                                </div>
                            </div>
                            <input type="hidden" id="galImageData">
                            <button type="submit" id="galBtn" class="btn-red w-full py-5">
                                <i data-lucide="hard-drive" class="w-4 h-4"></i> Commit Archive
                            </button>
                        </form>
                    </div>

                    <div class="lg:col-span-2">
                        <div id="archiveList" class="grid grid-cols-1 sm:grid-cols-2 gap-6"></div>
                    </div>
                </div>
            </section>

            <!-- SIGNALS -->
            <section id="signalSection" class="space-y-12">
                <div class="flex justify-between items-end border-b border-white/5 pb-8 text-left">
                    <div>
                        <h2 class="text-2xl font-black uppercase tracking-widest text-white">Signal <span class="text-red-600">Intercept</span></h2>
                        <p class="text-[10px] text-zinc-600 uppercase tracking-widest mt-2">Communications intercepted from the grid terminal</p>
                    </div>
                </div>
                <div id="signalList" class="grid grid-cols-1 xl:grid-cols-2 gap-8 max-h-[1200px] overflow-y-auto pr-4 custom-scrollbar"></div>
            </section>
        </main>
    </div>

    <!-- Hidden file inputs -->
    <input type="file" id="evFile" class="hidden">
    <input type="file" id="galFile" class="hidden">
    <input type="file" id="mgFile" class="hidden">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged, signOut, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, addDoc, updateDoc, deleteDoc, serverTimestamp, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // INIT
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyCJv9cd_QhzNiwC2_nDd4LwnMANhBOsET8",
            authDomain: "popetown-productions-llc.firebaseapp.com",
            projectId: "popetown-productions-llc",
            storageBucket: "popetown-productions-llc.firebasestorage.app",
            messagingSenderId: "436709069476",
            appId: "1:436709069476:web:bbc0fcbe160b71fabccc31"
        };

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'popetown-productions-llc';
        const initialToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        let activeListeners = [];
        let isStaffAuthorized = false;
        let masterData = { events: [], signals: [], archive: [], media_gallery: [] };

        const toast = (msg) => {
            const el = document.getElementById('errorToast');
            el.innerText = msg; el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 6000);
        };

        const toggleInterface = (isAuthorized) => {
            isStaffAuthorized = isAuthorized;
            document.getElementById('accessBarrier').classList.toggle('hidden', isAuthorized);
            document.getElementById('adminContent').classList.toggle('hidden', !isAuthorized);
            document.getElementById('adminNav').style.display = isAuthorized ? 'flex' : 'none';
            if (isAuthorized) { initThree(); startStreams(); }
            else activeListeners.forEach(u => u());
        };

        function startStreams() {
            if (!auth.currentUser) return;
            const paths = {
                events: collection(db, 'artifacts', appId, 'public', 'data', 'events'),
                signals: collection(db, 'artifacts', appId, 'public', 'data', 'inquiries'),
                archive: collection(db, 'artifacts', appId, 'public', 'data', 'gallery'),
                mg: collection(db, 'artifacts', appId, 'public', 'data', 'media_gallery')
            };

            activeListeners.push(onSnapshot(paths.events, (snap) => {
                masterData.events = snap.docs.map(d => ({id: d.id, ...d.data()}));
                document.getElementById('statEvents').innerText = masterData.events.length.toString().padStart(2, '0');
                renderEvents();
            }));

            activeListeners.push(onSnapshot(paths.signals, (snap) => {
                masterData.signals = snap.docs.map(d => ({id: d.id, ...d.data()}));
                document.getElementById('statSignals').innerText = masterData.signals.length.toString().padStart(2, '0');
                renderSignals();
            }));

            activeListeners.push(onSnapshot(paths.archive, (snap) => {
                masterData.archive = snap.docs.map(d => ({id: d.id, ...d.data()}));
                renderArchive();
            }));

            activeListeners.push(onSnapshot(paths.mg, (snap) => {
                masterData.media_gallery = snap.docs.map(d => ({id: d.id, ...d.data()}));
                renderMediaGallery();
            }));
        }

        // RENDERERS
        function renderMediaGallery() {
            const list = document.getElementById('mediaGalleryList');
            if (masterData.media_gallery.length === 0) {
                list.innerHTML = `<div class="col-span-2 py-10 text-center text-[9px] text-zinc-700 uppercase tracking-widest italic">Media Core Offline</div>`;
                return;
            }
            list.innerHTML = masterData.media_gallery.map(i => {
                const isVideo = i.type === 'video';
                return `
                <div class="glass-panel group relative aspect-video overflow-hidden bg-black text-left">
                    ${isVideo ? 
                        `<video src="${i.url}" muted loop playsinline class="w-full h-full object-cover opacity-60"></video>` : 
                        `<img src="${i.url}" class="w-full h-full object-cover opacity-60">`}
                    <div class="absolute inset-0 p-6 flex flex-col justify-end bg-gradient-to-t from-black to-transparent">
                        <p class="text-[9px] font-black uppercase text-red-600 mb-1 tracking-widest">${i.category || 'Capture'}</p>
                        <h4 class="text-xs font-bold text-white uppercase">${i.title}</h4>
                        <div class="mt-4 flex gap-2">
                            <button onclick="window.purgeNode('media_gallery', '${i.id}')" class="bg-red-600/20 text-red-500 border border-red-600/30 p-2 hover:bg-red-600 hover:text-white transition-all">
                                <i data-lucide="trash-2" class="w-3 h-3"></i>
                            </button>
                        </div>
                    </div>
                </div>`;
            }).join('');
            if (window.lucide) lucide.createIcons();
            document.querySelectorAll('#mediaGalleryList video').forEach(v => v.play().catch(()=>{}));
        }

        function renderEvents() {
            const list = document.getElementById('eventList');
            list.innerHTML = masterData.events.map(item => `
                <div class="glass-panel p-8 flex flex-col md:flex-row justify-between items-center gap-8 group text-left">
                    <div class="flex items-center gap-8 w-full">
                        <div class="w-24 h-24 bg-black border border-white/5 flex-shrink-0 overflow-hidden relative">
                            ${item.imagePath ? `<img src="${item.imagePath}" class="w-full h-full object-cover">` : `<div class="w-full h-full flex items-center justify-center text-[8px] opacity-10">NULL</div>`}
                        </div>
                        <div class="space-y-2 flex-1">
                            <span class="px-2 py-0.5 rounded-full border border-red-600 text-[8px] text-red-500 font-black uppercase">${item.status}</span>
                            <h4 class="text-xl font-black italic uppercase text-white">${item.title}</h4>
                            ${item.ticketLink ? `<a href="${item.ticketLink}" target="_blank" class="text-[8px] text-red-500 font-bold uppercase tracking-widest border-b border-red-600/30">:: VIEW_TICKETS</a>` : ''}
                        </div>
                    </div>
                    <div class="flex md:flex-col gap-3">
                        <button onclick="window.editNode('${item.id}')" class="text-[9px] text-white uppercase border border-white/10 px-8 py-3 hover:bg-white/5 font-black">EDIT</button>
                        <button onclick="window.purgeNode('events', '${item.id}')" class="text-[9px] text-white uppercase bg-red-600/10 border border-red-600/20 px-8 py-3 hover:bg-red-600 font-black">PURGE</button>
                    </div>
                </div>
            `).join('');
            if (window.lucide) lucide.createIcons();
        }

        function renderArchive() {
            const list = document.getElementById('archiveList');
            list.innerHTML = masterData.archive.map(i => `
                <div class="glass-panel group relative aspect-square overflow-hidden bg-black text-left">
                    <img src="${i.imageURL}" class="w-full h-full object-cover opacity-60">
                    <div class="absolute inset-0 p-6 flex flex-col justify-end">
                        <p class="text-[10px] font-black uppercase text-white">${i.title}</p>
                        <button onclick="window.purgeNode('gallery', '${i.id}')" class="mt-4 bg-red-600 p-2 w-fit rounded hover:bg-red-500">
                            <i data-lucide="trash-2" class="w-3 h-3 text-white"></i>
                        </button>
                    </div>
                </div>
            `).join('');
            if (window.lucide) lucide.createIcons();
        }

        function renderSignals() {
            const list = document.getElementById('signalList');
            list.innerHTML = masterData.signals.map(i => `
                <div class="glass-panel p-10 border-l-4 ${i.flagged ? 'border-red-600' : 'border-white/5'} space-y-6 text-left">
                    <div>
                        <p class="text-lg font-black text-red-600 uppercase italic">${i.fullName}</p>
                        <p class="text-[9px] text-zinc-600 uppercase font-mono">${i.email}</p>
                    </div>
                    <p class="text-sm text-zinc-400 italic border-l border-white/10 pl-6">"${i.message}"</p>
                    <div class="flex justify-between items-center pt-4 border-t border-white/5">
                        <button onclick="window.flagNode('${i.id}', ${!i.flagged})" class="text-[9px] font-black uppercase tracking-widest ${i.flagged ? 'text-red-500' : 'text-zinc-700'}">:: FLAG</button>
                        <button onclick="window.purgeNode('inquiries', '${i.id}')" class="text-[9px] text-zinc-800 hover:text-red-600 font-black">TERMINATE</button>
                    </div>
                </div>
            `).join('');
        }

        // ASSET UPLINK
        const uploadFile = async (file, progressEl, containerEl) => {
            return new Promise((resolve, reject) => {
                if (!auth.currentUser) return reject("UNAUTHORIZED");
                const path = `artifacts/${appId}/public/assets/${Date.now()}_${file.name.replace(/\s/g, '_')}`;
                const task = uploadBytesResumable(ref(storage, path), file);
                containerEl.classList.remove('hidden');
                task.on('state_changed', 
                    s => progressEl.style.width = (s.bytesTransferred / s.totalBytes) * 100 + '%',
                    e => { containerEl.classList.add('hidden'); reject(e); },
                    () => getDownloadURL(task.snapshot.ref).then(url => { containerEl.classList.add('hidden'); resolve(url); })
                );
            });
        };

        window.clearAsset = (prefix) => {
            document.getElementById(`${prefix}ImageData`).value = "";
            document.getElementById(`${prefix}Preview`).classList.add('hidden');
            if(document.getElementById(`${prefix}VideoPreview`)) document.getElementById(`${prefix}VideoPreview`).classList.add('hidden');
            document.getElementById(`${prefix}Prompt`).classList.remove('hidden');
            document.getElementById(`${prefix}ImageActions`).classList.add('hidden');
        };

        // HANDLERS
        document.getElementById('loginForm').onsubmit = async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const pass = document.getElementById('loginPass').value;
            try {
                await signInWithEmailAndPassword(auth, email, pass);
            } catch(err) { toast("AUTH_FAILED // ACCESS_DENIED"); }
        };

        document.getElementById('logoutBtn').onclick = () => { toggleInterface(false); signOut(auth); };

        document.getElementById('mediaGalleryForm').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('mgBtn');
            btn.disabled = true;
            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'media_gallery'), {
                    title: document.getElementById('mgTitle').value,
                    type: document.getElementById('mgType').value,
                    category: document.getElementById('mgCategory').value,
                    url: document.getElementById('mgImageData').value,
                    timestamp: serverTimestamp()
                });
                toast("MEDIA_BROADCAST_SUCCESS");
                e.target.reset();
                window.clearAsset('mg');
            } catch(err) { toast("BROADCAST_FAIL"); }
            btn.disabled = false;
        };

        document.getElementById('eventForm').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('evBtn'), id = document.getElementById('editEventId').value;
            btn.disabled = true;
            try {
                const payload = {
                    title: document.getElementById('evTitle').value,
                    date: Timestamp.fromDate(new Date(document.getElementById('evDate').value)),
                    status: document.getElementById('evStatus').value,
                    ticketLink: document.getElementById('evTicketLink').value || null,
                    description: document.getElementById('evDesc').value,
                    imagePath: document.getElementById('evImageData').value || "",
                    timestamp: serverTimestamp()
                };
                if (id) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'events', id), payload);
                else await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'events'), payload);
                document.getElementById('evCancelBtn').click();
                toast("SYNC_SUCCESS");
            } catch (err) { toast("SYNC_FAIL"); }
            btn.disabled = false;
        };

        window.editNode = (id) => {
            const i = masterData.events.find(e => e.id === id);
            if (!i) return;
            document.getElementById('editEventId').value = id;
            document.getElementById('evTitle').value = i.title;
            document.getElementById('evStatus').value = i.status;
            document.getElementById('evTicketLink').value = i.ticketLink || '';
            document.getElementById('evDesc').value = i.description || '';
            if (i.date) document.getElementById('evDate').value = i.date.toDate().toISOString().split('T')[0];
            if (i.imagePath) {
                document.getElementById('evPreview').src = i.imagePath;
                document.getElementById('evPreview').classList.remove('hidden');
                document.getElementById('evPrompt').classList.add('hidden');
                document.getElementById('evImageActions').classList.remove('hidden');
                document.getElementById('evImageData').value = i.imagePath;
            }
            document.getElementById('evCancelBtn').classList.remove('hidden');
            window.scrollTo({ top: document.getElementById('eventSection').offsetTop - 120, behavior: 'smooth' });
        };

        document.getElementById('evCancelBtn').onclick = () => {
            document.getElementById('eventForm').reset();
            document.getElementById('editEventId').value = "";
            window.clearAsset('ev');
            document.getElementById('evCancelBtn').classList.add('hidden');
        };

        window.flagNode = async (id, s) => {
            try { await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'inquiries', id), { flagged: s }); }
            catch (e) { toast("FLAG_FAIL"); }
        };

        window.purgeNode = async (c, id) => {
            if (!confirm("PURGE PERMANENTLY FROM CORE?")) return;
            try { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', c, id)); toast("NODE_PURGED"); }
            catch (e) { toast("PURGE_REJECTED"); }
        };

        // FILE UPLOAD TRIGGERS
        const setupUploader = (inputId, prevId, vidPrevId, dataId, promptId, actionsId, cId, bId) => {
            document.getElementById(inputId).onchange = async (e) => {
                const f = e.target.files[0]; if (!f) return;
                try {
                    const url = await uploadFile(f, document.getElementById(bId), document.getElementById(cId));
                    document.getElementById(dataId).value = url;
                    document.getElementById(promptId).classList.add('hidden');
                    document.getElementById(actionsId).classList.remove('hidden');
                    
                    if (f.type.startsWith('video/')) {
                        if(vidPrevId) {
                            const v = document.getElementById(vidPrevId);
                            v.src = url; v.classList.remove('hidden'); v.play();
                            if(prevId) document.getElementById(prevId).classList.add('hidden');
                        }
                    } else {
                        if(prevId) {
                            const i = document.getElementById(prevId);
                            i.src = url; i.classList.remove('hidden');
                            if(vidPrevId) document.getElementById(vidPrevId).classList.add('hidden');
                        }
                    }
                    toast("SIGNAL_BROADCAST_LOCKED");
                } catch (err) { toast("UPLINK_ABORTED"); }
            };
        };

        setupUploader('evFile', 'evPreview', null, 'evImageData', 'evPrompt', 'evImageActions', 'evProgressContainer', 'evProgressBar');
        setupUploader('galFile', 'galPreview', null, 'galImageData', 'galPrompt', 'galImageActions', 'galProgressContainer', 'galProgressBar');
        setupUploader('mgFile', 'mgPreview', 'mgVideoPreview', 'mgImageData', 'mgPrompt', 'mgImageActions', 'mgProgressContainer', 'mgProgressBar');

        document.getElementById('galleryForm').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('galBtn');
            btn.disabled = true;
            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'gallery'), {
                    title: document.getElementById('galTitle').value,
                    logId: document.getElementById('galLog').value,
                    imageURL: document.getElementById('galImageData').value,
                    timestamp: serverTimestamp()
                });
                toast("ARCHIVE_COMMITTED");
                e.target.reset();
                window.clearAsset('gal');
            } catch (err) { toast("SYNC_FAIL"); }
            btn.disabled = false;
        };

        function initThree() {
            const container = document.getElementById('canvas-container');
            if (!container || container.innerHTML !== "") return;
            const scene = new THREE.Scene(), cam = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000), ren = new THREE.WebGLRenderer({ alpha: true, antialias: true });
            ren.setSize(window.innerWidth, window.innerHeight);
            container.appendChild(ren.domElement);
            const pts = []; for (let i=0; i<2500; i++) pts.push(THREE.MathUtils.randFloatSpread(50), THREE.MathUtils.randFloatSpread(50), THREE.MathUtils.randFloatSpread(50));
            const geo = new THREE.BufferGeometry(); geo.setAttribute('position', new THREE.Float32BufferAttribute(pts, 3));
            const mat = new THREE.PointsMaterial({ color: 0xff0000, size: 0.05, transparent: true, opacity: 0.3 });
            const cloud = new THREE.Points(geo, mat); scene.add(cloud); cam.position.z = 15;
            function anim() { requestAnimationFrame(anim); cloud.rotation.y += 0.0004; ren.render(scene, cam); }
            anim();
        }

        window.onload = async () => {
            const stat = document.getElementById('initStatus');
            try {
                if (initialToken) await signInWithCustomToken(auth, initialToken);
                else await signInAnonymously(auth);
                stat.innerText = "Link Stable // Staff Credentials Required";
            } catch (err) { stat.innerText = "Grid Link Failure"; }
            
            onAuthStateChanged(auth, (user) => {
                if (user && !user.isAnonymous) toggleInterface(true);
                else toggleInterface(false);
            });
            if (window.lucide) lucide.createIcons();
        };

        document.getElementById('globalSearch').oninput = () => { renderEvents(); renderSignals(); renderArchive(); renderMediaGallery(); };
    </script>
</body>
</html>
