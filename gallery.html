<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POPETOWN | Media Gallery Core</title>
    <!-- Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root { --brand-red: #ff0000; --bg-black: #050505; }
        body { background-color: var(--bg-black); color: #ffffff; font-family: 'Inter', sans-serif; overflow-x: hidden; scroll-behavior: smooth; }
        h1, h2, h3, .nav-link { font-family: 'Orbitron', sans-serif; }
        
        #mainNav {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 80px !important;
            z-index: 9999 !important;
            background: rgba(0, 0, 0, 0.95) !important;
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 0, 0, 0.3);
            display: flex !important;
            align-items: center;
        }

        .glass-panel { 
            background: rgba(15, 15, 15, 0.95); 
            border: 1px solid rgba(255, 255, 255, 0.05); 
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .media-card {
            position: relative;
            aspect-ratio: 16/9;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.05);
            background: #000;
            backface-visibility: hidden;
            transform: translateZ(0);
            cursor: pointer;
        }

        .media-card:hover {
            border-color: var(--brand-red);
            box-shadow: 0 0 30px rgba(255, 0, 0, 0.2);
        }

        .media-asset {
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0;
            transition: opacity 1s ease, transform 0.6s ease;
            will-change: opacity;
        }

        .media-asset.loaded { opacity: 0.85; }
        .media-card:hover .media-asset.loaded { opacity: 1; transform: scale(1.05); }

        .neon-accent { color: var(--brand-red); text-shadow: 0 0 10px rgba(255, 0, 0, 0.8); }

        #canvas-container { position: fixed; top: 0; left: 0; z-index: -1; width: 100%; height: 100%; pointer-events: none; }

        .filter-btn {
            font-size: 10px;
            font-weight: 900;
            letter-spacing: 2px;
            text-transform: uppercase;
            padding: 8px 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: 0.3s;
            color: #666;
        }

        .filter-btn.active {
            border-color: var(--brand-red);
            color: white;
            background: rgba(255, 0, 0, 0.1);
        }

        .media-info {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 20px;
            background: linear-gradient(to top, black, transparent);
            transform: translateY(10px);
            opacity: 0;
            transition: 0.4s;
            text-align: left;
        }

        .media-card:hover .media-info {
            transform: translateY(0);
            opacity: 1;
        }

        .video-indicator {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255, 0, 0, 0.8);
            padding: 4px;
            border-radius: 4px;
            z-index: 10;
        }

        #lightbox {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.98);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 40px;
        }
    </style>
</head>
<body>

    <div id="canvas-container"></div>

    <!-- Lightbox -->
    <div id="lightbox" onclick="this.style.display='none'">
        <div id="lightbox-content" class="max-w-6xl w-full h-full flex items-center justify-center"></div>
        <button class="absolute top-10 right-10 text-white hover:text-red-600 transition">
            <i data-lucide="x" class="w-10 h-10"></i>
        </button>
    </div>

    <!-- Navigation -->
    <nav id="mainNav">
        <div class="max-w-7xl mx-auto w-full px-8 flex justify-between items-center">
            <div class="flex items-center gap-12">
                <a href="index.html" class="text-xl md:text-2xl font-bold uppercase tracking-tighter italic text-white no-underline">
                    POPETOWN <span class="neon-accent">PRODUCTIONS</span>
                </a>
                <div class="hidden md:flex items-center gap-8 border-l border-white/10 pl-8">
                    <a href="index.html" class="text-[10px] font-bold tracking-[0.2em] hover:text-red-500 transition-colors uppercase text-white no-underline">Grid_Main</a>
                    <a href="#" class="text-[10px] font-bold tracking-[0.2em] text-red-500 transition-colors uppercase no-underline">Media_Core</a>
                </div>
            </div>
            <a href="index.html#contact" class="text-[10px] font-black uppercase border border-red-600 px-6 py-2 hover:bg-red-600 transition-all tracking-widest text-white no-underline">Contact_Uplink</a>
        </div>
    </nav>

    <!-- Header -->
    <header class="pt-48 pb-20 px-8 max-w-7xl mx-auto text-left">
        <p class="text-red-600 font-black tracking-[0.5em] text-[10px] uppercase mb-4 animate-pulse">:: Visual Archive Database ::</p>
        <h1 class="text-6xl md:text-8xl font-black uppercase tracking-tighter italic leading-none mb-10">MEDIA<br><span class="neon-accent">GALLERY</span></h1>
        
        <div class="flex flex-wrap gap-4 mt-12 border-t border-white/5 pt-8">
            <button onclick="filterGallery('all')" class="filter-btn active" id="btn-all">All_Assets</button>
            <button onclick="filterGallery('video')" class="filter-btn" id="btn-video">Visual_Motion</button>
            <button onclick="filterGallery('image')" class="filter-btn" id="btn-image">Still_Captures</button>
        </div>
    </header>

    <!-- Gallery Grid -->
    <main class="px-8 pb-40 max-w-7xl mx-auto">
        <div id="media-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 text-left">
            <!-- Shimmer Loading -->
            <div class="media-card glass-panel bg-zinc-900/20 animate-pulse"></div>
            <div class="media-card glass-panel bg-zinc-900/20 animate-pulse"></div>
            <div class="media-card glass-panel bg-zinc-900/20 animate-pulse"></div>
        </div>
    </main>

    <footer class="py-20 border-t border-white/5 text-center px-8">
        <p class="text-[9px] tracking-[0.4em] text-zinc-600 uppercase mb-8">&copy; 2026 POPETOWN MEDIA CORE // BROADCASTING WORLDWIDE</p>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // CONFIG
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'popetown-productions-llc';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyCJv9cd_QhzNiwC2_nDd4LwnMANhBOsET8",
            authDomain: "popetown-productions-llc.firebaseapp.com",
            projectId: "popetown-productions-llc",
            storageBucket: "popetown-productions-llc.firebasestorage.app",
            messagingSenderId: "436709069476",
            appId: "1:436709069476:web:bbc0fcbe160b71fabccc31"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        let allMedia = [];
        let currentFilter = 'all';

        // Global decoder triggers
        window.onAssetLoad = (el) => el.classList.add('loaded');

        // CORS Fallback - Same as index.html for high-res assets
        window.handleMediaError = (el) => {
            if (el.hasAttribute('crossorigin')) {
                el.removeAttribute('crossorigin');
                const src = el.src || (el.querySelector('source') ? el.querySelector('source').src : '');
                if (el.tagName === 'VIDEO') {
                    el.load();
                } else {
                    el.src = src;
                }
            }
        };

        const performAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (err) { await signInAnonymously(auth); }
        };

        window.onload = async () => {
            initThree();
            await performAuth();
            
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    const q = query(collection(db, "artifacts", appId, "public", "data", "media_gallery"), orderBy("timestamp", "desc"));
                    onSnapshot(q, (snap) => {
                        allMedia = snap.docs.map(d => ({id: d.id, ...d.data()}));
                        renderGallery();
                    });
                }
            });
            lucide.createIcons();
        };

        window.renderGallery = () => {
            const grid = document.getElementById('media-grid');
            const filtered = allMedia.filter(m => currentFilter === 'all' || m.type === currentFilter);

            if (filtered.length === 0) {
                grid.innerHTML = `<div class="col-span-full py-40 text-center text-[10px] text-zinc-700 uppercase tracking-[1em]">Core_Memory_Empty</div>`;
                return;
            }

            grid.innerHTML = filtered.map(media => {
                const isVideo = media.type === 'video';
                return `
                    <div class="media-card group glass-panel" onclick="openLightbox('${media.url}', ${isVideo})">
                        ${isVideo ? `
                            <div class="video-indicator"><i data-lucide="play" class="w-3 h-3 text-white fill-white"></i></div>
                            <video class="media-asset" muted loop playsinline crossorigin="anonymous" onerror="handleMediaError(this)" onplay="onAssetLoad(this)">
                                <source src="${media.url}" type="video/mp4">
                            </video>
                        ` : `
                            <img src="${media.url}" crossorigin="anonymous" onerror="handleMediaError(this)" class="media-asset" onload="onAssetLoad(this)" loading="lazy">
                        `}
                        <div class="media-info text-left">
                            <p class="text-red-500 font-black text-[9px] uppercase tracking-[0.2em] mb-1">${media.category || 'Capture'}</p>
                            <h3 class="text-white text-sm font-bold uppercase tracking-widest">${media.title || 'Untitled_Capture'}</h3>
                        </div>
                    </div>
                `;
            }).join('');
            
            lucide.createIcons();
            // Start visible videos
            document.querySelectorAll('video').forEach(v => v.play().catch(() => {}));
        };

        window.filterGallery = (type) => {
            currentFilter = type;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.toggle('active', b.id === `btn-${type}`));
            renderGallery();
        };

        window.openLightbox = (url, isVideo) => {
            const lb = document.getElementById('lightbox');
            const content = document.getElementById('lightbox-content');
            lb.style.display = 'flex';
            content.innerHTML = isVideo ? 
                `<video controls autoplay class="max-w-full max-h-full border border-white/10 shadow-2xl"><source src="${url}" type="video/mp4"></video>` : 
                `<img src="${url}" class="max-w-full max-h-full object-contain border border-white/10 shadow-2xl">`;
        };

        function initThree() {
            const container = document.getElementById('canvas-container');
            const sc = new THREE.Scene(), cam = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000), ren = new THREE.WebGLRenderer({ alpha: true });
            ren.setSize(window.innerWidth, window.innerHeight);
            container.appendChild(ren.domElement);
            const geo = new THREE.BufferGeometry(), count = 1000, pos = new Float32Array(count*3);
            for(let i=0; i<count*3; i++) pos[i] = (Math.random()-0.5)*30;
            geo.setAttribute('position', new THREE.BufferAttribute(pos, 3));
            sc.add(new THREE.Points(geo, new THREE.PointsMaterial({ size: 0.008, color: 0xff0000, transparent: true, opacity: 0.3 })));
            cam.position.z = 12;
            function anim() { requestAnimationFrame(anim); sc.rotation.y += 0.0002; ren.render(sc, cam); }
            anim();
        }
    </script>
</body>
</html>
