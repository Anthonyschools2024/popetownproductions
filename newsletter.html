<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POPETOWN | Newsletter Hub</title>
    <!-- Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --brand-red: #ff0000; --bg-black: #050505; }
        body { background-color: var(--bg-black); color: #ffffff; font-family: 'Inter', sans-serif; overflow-x: hidden; scroll-behavior: smooth; }
        h1, h2, h3, .nav-link { font-family: 'Orbitron', sans-serif; }
        
        #mainNav {
            position: fixed !important;
            top: 0 !important; left: 0 !important;
            width: 100% !important; height: 80px !important;
            z-index: 9999 !important;
            background: rgba(0, 0, 0, 0.95) !important;
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 0, 0, 0.3);
            display: flex !important;
            align-items: center;
        }

        .glass-panel { 
            background: rgba(15, 15, 15, 0.95); 
            border: 1px solid rgba(255, 255, 255, 0.05); 
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }

        .newsletter-card {
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.4s ease;
        }
        .newsletter-card:hover { border-color: var(--brand-red); }

        .comment-item {
            border-left: 2px solid rgba(255, 0, 0, 0.2);
            background: rgba(255, 255, 255, 0.02);
            transition: 0.3s;
        }
        .comment-item:hover { border-left-color: var(--brand-red); background: rgba(255, 0, 0, 0.03); }

        .neon-accent { color: var(--brand-red); text-shadow: 0 0 10px rgba(255, 0, 0, 0.8); }

        input, textarea { 
            background: rgba(255, 255, 255, 0.03); 
            border: 1px solid rgba(255, 255, 255, 0.1); 
            color: white; padding: 0.75rem; outline: none; 
            width: 100%; transition: 0.3s;
        }
        input:focus, textarea:focus { border-color: var(--brand-red); }

        #canvas-container { position: fixed; top: 0; left: 0; z-index: -1; width: 100%; height: 100%; pointer-events: none; }

        .btn-submit {
            background: var(--brand-red); color: white;
            font-family: 'Orbitron', sans-serif; font-weight: 900;
            text-transform: uppercase; letter-spacing: 2px;
            padding: 10px 20px; font-size: 10px; cursor: pointer;
            transition: 0.3s;
        }
        .btn-submit:hover { box-shadow: 0 0 20px rgba(255, 0, 0, 0.5); }
    </style>
</head>
<body>

    <div id="canvas-container"></div>

    <!-- Navigation -->
    <nav id="mainNav">
        <div class="max-w-7xl mx-auto w-full px-8 flex justify-between items-center">
            <div class="flex items-center gap-12 text-left">
                <a href="index.html" class="text-xl md:text-2xl font-bold uppercase tracking-tighter italic text-white no-underline">
                    POPETOWN <span class="neon-accent">PRODUCTIONS</span>
                </a>
                <div class="hidden lg:flex items-center gap-6 border-l border-white/10 pl-8">
                    <a href="index.html" class="text-[10px] font-bold tracking-[0.2em] hover:text-red-500 transition-colors uppercase text-white no-underline">Home</a>
                    <a href="gallery.html" class="text-[10px] font-bold tracking-[0.2em] hover:text-red-500 transition-colors uppercase text-white no-underline">Gallery</a>
                    <a href="#" class="text-[10px] font-bold tracking-[0.2em] text-red-500 uppercase no-underline">Newsletter</a>
                </div>
            </div>
            <a href="admin.html" class="text-[10px] font-black uppercase border border-white/10 px-6 py-2 hover:border-red-600 transition-all tracking-widest text-white no-underline">Staff_Login</a>
        </div>
    </nav>

    <!-- Header Section -->
    <header class="pt-48 pb-20 px-8 max-w-5xl mx-auto text-left">
        <p class="text-red-600 font-black tracking-[0.5em] text-[10px] uppercase mb-4 animate-pulse">:: GLOBAL INTEL FEED ::</p>
        <h1 class="text-5xl md:text-7xl font-black uppercase tracking-tighter italic leading-none mb-6">POPETOWN<br><span class="neon-accent">NEWSLETTER</span></h1>
        <p class="text-zinc-500 text-sm tracking-widest uppercase font-light max-w-xl">Deep dives into production mechanics, artist spotlights, and exclusive community updates.</p>
    </header>

    <!-- Main Feed -->
    <main class="px-8 pb-40 max-w-5xl mx-auto space-y-20" id="newsletter-feed">
        <!-- Shimmer Loading States -->
        <div class="glass-panel p-10 h-[400px] animate-pulse rounded-sm"></div>
        <div class="glass-panel p-10 h-[400px] animate-pulse rounded-sm"></div>
    </main>

    <!-- Footer -->
    <footer class="py-20 border-t border-white/5 text-center px-8">
        <p class="text-[9px] tracking-[0.4em] text-zinc-600 uppercase mb-4">&copy; 2026 POPETOWN HUB // SECURE COMMUNICATIONS ACTIVE</p>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, query, orderBy, addDoc, serverTimestamp, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'popetown-productions-llc';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyCJv9cd_QhzNiwC2_nDd4LwnMANhBOsET8",
            authDomain: "popetown-productions-llc.firebaseapp.com",
            projectId: "popetown-productions-llc",
            storageBucket: "popetown-productions-llc.firebasestorage.app",
            messagingSenderId: "436709069476",
            appId: "1:436709069476:web:bbc0fcbe160b71fabccc31"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        let newsletterData = [];
        let commentListeners = {};

        // Auth and Load
        window.onload = async () => {
            initThree();
            try {
                await signInAnonymously(auth);
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        const q = query(collection(db, "artifacts", appId, "public", "data", "newsletter"), orderBy("timestamp", "desc"));
                        onSnapshot(q, (snap) => {
                            newsletterData = snap.docs.map(d => ({id: d.id, ...d.data()}));
                            renderFeed();
                        });
                    }
                });
            } catch (err) { console.error("Link Failure", err); }
            lucide.createIcons();
        };

        function renderFeed() {
            const feed = document.getElementById('newsletter-feed');
            if (newsletterData.length === 0) {
                feed.innerHTML = `<div class="py-40 text-center text-[10px] text-zinc-700 uppercase tracking-[1em]">Intelligence_Feed_Empty</div>`;
                return;
            }

            feed.innerHTML = newsletterData.map(post => {
                const date = post.timestamp?.toDate ? post.timestamp.toDate().toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' }) : 'BROADCAST_PENDING';
                return `
                    <article class="glass-panel newsletter-card overflow-hidden text-left" id="post-${post.id}">
                        ${post.imagePath ? `<img src="${post.imagePath}" class="w-full h-80 object-cover border-b border-white/5 opacity-80">` : ''}
                        <div class="p-10 md:p-16 space-y-8">
                            <div>
                                <p class="text-red-600 font-bold text-[10px] tracking-[0.4em] uppercase mb-2">${date}</p>
                                <h2 class="text-3xl md:text-5xl font-black uppercase tracking-tighter italic text-white">${post.title}</h2>
                            </div>
                            <div class="text-zinc-400 text-lg leading-relaxed font-light whitespace-pre-wrap">${post.content}</div>
                            
                            <!-- Comment System -->
                            <div class="pt-12 border-t border-white/5">
                                <h4 class="text-xs font-black uppercase tracking-widest text-zinc-500 mb-8 flex items-center gap-3">
                                    <i data-lucide="message-square" class="w-4 h-4"></i> Public Signatures
                                </h4>
                                
                                <div id="comments-${post.id}" class="space-y-6 mb-12">
                                    <p class="text-[9px] text-zinc-800 uppercase tracking-widest italic">Scanning for signals...</p>
                                </div>

                                <form onsubmit="window.postComment(event, '${post.id}')" class="space-y-4 bg-white/5 p-6 rounded-sm">
                                    <div class="grid md:grid-cols-2 gap-4">
                                        <input type="text" placeholder="Identity (Display Name)" required id="name-${post.id}" class="text-xs">
                                        <button type="submit" class="btn-submit">Broadcast Signature</button>
                                    </div>
                                    <textarea placeholder="Transmission details..." required id="text-${post.id}" rows="2" class="text-xs"></textarea>
                                </form>
                            </div>
                        </div>
                    </article>
                `;
            }).join('');
            
            lucide.createIcons();
            
            // Attach individual comment listeners for each post
            newsletterData.forEach(post => {
                if (commentListeners[post.id]) commentListeners[post.id]();
                const q = query(collection(db, "artifacts", appId, "public", "data", "newsletter_comments"), orderBy("timestamp", "asc"));
                commentListeners[post.id] = onSnapshot(q, (snap) => {
                    const allComments = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    const postComments = allComments.filter(c => c.newsletterId === post.id);
                    renderComments(post.id, postComments);
                });
            });
        }

        function renderComments(postId, comments) {
            const container = document.getElementById(`comments-${postId}`);
            if (!container) return;

            if (comments.length === 0) {
                container.innerHTML = `<p class="text-[9px] text-zinc-700 uppercase tracking-widest italic">Awaiting community feedback...</p>`;
                return;
            }

            container.innerHTML = comments.map(c => {
                const time = c.timestamp?.toDate ? c.timestamp.toDate().toLocaleString() : '...';
                const isAdmin = c.isAdmin ? '<span class="text-[8px] bg-red-600 text-white px-2 py-0.5 rounded-full ml-2">ADMIN</span>' : '';
                return `
                    <div class="comment-item p-4 space-y-2">
                        <div class="flex justify-between items-center">
                            <span class="text-[10px] font-black uppercase text-red-500 tracking-widest">${c.authorName}${isAdmin}</span>
                            <span class="text-[8px] font-mono text-zinc-700">${time}</span>
                        </div>
                        <p class="text-sm text-zinc-400 font-light leading-relaxed">${c.text}</p>
                    </div>
                `;
            }).join('');
        }

        window.postComment = async (e, postId) => {
            e.preventDefault();
            const nameEl = document.getElementById(`name-${postId}`);
            const textEl = document.getElementById(`text-${postId}`);
            const btn = e.target.querySelector('button');

            btn.disabled = true;
            try {
                await addDoc(collection(db, "artifacts", appId, "public", "data", "newsletter_comments"), {
                    newsletterId: postId,
                    authorName: nameEl.value,
                    text: textEl.value,
                    timestamp: serverTimestamp(),
                    isAdmin: false // Default to false for public comments
                });
                textEl.value = '';
            } catch (err) { console.error("Transmission failed", err); }
            btn.disabled = false;
        };

        function initThree() {
            const container = document.getElementById('canvas-container');
            const sc = new THREE.Scene(), cam = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000), ren = new THREE.WebGLRenderer({ alpha: true });
            ren.setSize(window.innerWidth, window.innerHeight);
            container.appendChild(ren.domElement);
            
            const geo = new THREE.BufferGeometry(), count = 1500, pos = new Float32Array(count*3);
            for(let i=0; i<count*3; i++) pos[i] = (Math.random()-0.5)*40;
            geo.setAttribute('position', new THREE.BufferAttribute(pos, 3));
            sc.add(new THREE.Points(geo, new THREE.PointsMaterial({ size: 0.006, color: 0xff0000, transparent: true, opacity: 0.2 })));
            
            cam.position.z = 15;
            function anim() { requestAnimationFrame(anim); sc.rotation.y += 0.0001; ren.render(sc, cam); }
            anim();
            window.addEventListener('resize', () => { cam.aspect=window.innerWidth/window.innerHeight; cam.updateProjectionMatrix(); ren.setSize(window.innerWidth, window.innerHeight); });
        }
    </script>
</body>
</html>
